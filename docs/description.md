# Receipt Printer Project Description

## 프로젝트 개요

이 프로젝트는 **BIXOLON SRP-330II 영수증 프린터**를 사용하여 텍스트를 출력하는 Python 기반 애플리케이션입니다. CUPS(Common Unix Printing System)를 통해 프린터와 통신하며, 한글과 영문 텍스트를 모두 지원합니다.

## 파일 구조

```
receipt-printer/
├── main.py           # 메인 실행 파일
├── requirements.txt  # Python 의존성 목록
└── docs/
    └── description.md # 프로젝트 설명서 (이 파일)
```

## 주요 기능

### 1. 텍스트 처리 기능

#### 1.1 텍스트 폭 계산 (`get_text_width`)
- **위치**: `main.py:12-20`
- **기능**: 한글과 영문 문자의 실제 출력 폭을 계산
- **로직**: 
  - 한글/특수문자 (ASCII > 127): 2칸
  - 영문/숫자: 1칸
- **용도**: 정확한 줄바꿈과 정렬을 위한 기반 함수

#### 1.2 텍스트 줄바꿈 (`wrap_text`)
- **위치**: `main.py:22-52`
- **기능**: 지정된 폭(기본 40자)에 맞춰 텍스트를 자동 줄바꿈
- **특징**:
  - 단어 단위로 줄바꿈 (단어 중간에서 끊어지지 않음)
  - 한글과 영문의 폭 차이를 고려한 정확한 계산
  - 공백 문자도 폭 계산에 포함

#### 1.3 텍스트 가운데 정렬 (`center_text`)
- **위치**: `main.py:54-61`
- **기능**: 40자 폭 기준으로 텍스트를 가운데 정렬
- **로직**: 좌우 여백을 동일하게 배분하여 정렬

### 2. 출력 포맷팅 기능

#### 2.1 출력 내용 준비 (`prepare_print_content`)
- **위치**: `main.py:63-84`
- **기능**: 출력할 텍스트의 최종 레이아웃 구성
- **여백 규칙**:
  - 상단: 1줄 여백
  - 하단: 텍스트 줄 수에 따라 가변
    - 1줄: 3줄 여백
    - 2줄: 2줄 여백
    - 3줄 이상: 1줄 여백

#### 2.2 ESC/POS 명령어 생성 (`create_esc_pos_content`)
- **위치**: `main.py:86-120`
- **기능**: 프린터가 이해할 수 있는 ESC/POS 명령어 생성
- **주요 명령어**:
  - `\x1B\x40`: 프린터 초기화 (ESC @)
  - `\x1B\x74\x12`: 코드페이지 설정 (CP949/EUC-KR)
  - `\x1C\x26`, `\x1C\x2E`: 한글 모드 활성화
  - `\x1B\x61\x01`: 가운데 정렬 설정
  - `\x1B\x61\x00`: 좌측 정렬 복귀
  - `\x1D\x56\x00`: 용지 절단 (풀 컷)

### 3. 프린터 관리 기능

#### 3.1 프린터 목록 조회 (`get_available_printers`)
- **위치**: `main.py:122-135`
- **기능**: CUPS에 등록된 모든 프린터 목록 조회
- **방법**: `lpstat -p` 명령어 실행 및 파싱

#### 3.2 프린터 상태 확인 (`check_printer_status`)
- **위치**: `main.py:172-181`
- **기능**: 특정 프린터의 현재 상태 조회
- **정보**: 프린터 활성화 상태, 오류 여부 등

#### 3.3 CUPS 출력 (`print_to_cups`)
- **위치**: `main.py:137-170`
- **기능**: CUPS를 통한 실제 프린터 출력 수행
- **프로세스**:
  1. 텍스트 포맷팅 및 ESC/POS 명령어 생성
  2. 임시 바이너리 파일 생성
  3. `lp` 명령어로 raw 데이터 출력
  4. 임시 파일 정리
  5. 출력 결과 확인 및 피드백

## 문자 인코딩 처리

### 인코딩 우선순위
1. **EUC-KR**: 한글 출력을 위한 1차 시도
2. **UTF-8**: EUC-KR 인코딩 실패시 대체 인코딩

### 한글 지원 설정
- ESC/POS 명령어를 통한 코드페이지 설정
- 프린터 펌웨어 레벨에서의 한글 모드 활성화

## 명령행 인터페이스

### 기본 사용법
```bash
python3 main.py "출력할 텍스트"
```

### 옵션 매개변수

| 옵션 | 설명 | 예시 |
|------|------|------|
| `-p, --printer` | 프린터 이름 지정 | `-p BIXOLON_SRP_330II` |
| `--preview` | 출력 미리보기만 표시 | `--preview` |
| `--list-printers` | 사용 가능한 프린터 목록 | `--list-printers` |
| `--status` | 프린터 상태 확인 | `--status` |

### 사용 예시

```bash
# 기본 출력
python3 main.py "안녕하세요 반갑습니다"

# 특정 프린터로 출력
python3 main.py "영수증 출력" -p MY_PRINTER

# 출력 미리보기
python3 main.py "테스트 텍스트" --preview

# 프린터 목록 확인
python3 main.py --list-printers

# 프린터 상태 확인
python3 main.py --status -p BIXOLON_SRP_330II
```

## 에러 처리 및 문제 해결

### 자동 문제 해결 가이드
출력 실패시 다음 단계를 자동으로 안내:

1. **프린터 등록 확인**: `--list-printers` 옵션
2. **프린터 상태 확인**: `--status` 옵션  
3. **프린터 이름 확인**: `-p` 옵션으로 정확한 이름 지정
4. **CUPS 서비스 확인**: `brew services list | grep cups`
5. **출력 내용 확인**: `--preview` 옵션

### 일반적인 오류 상황

#### 프린터를 찾을 수 없음
- **원인**: CUPS에 프린터가 등록되지 않음
- **해결**: 시스템 설정에서 프린터 추가

#### 출력 명령 실패
- **원인**: 프린터 오프라인, 용지 부족, 연결 문제
- **해결**: 프린터 상태 확인 및 물리적 점검

#### 한글 출력 깨짐
- **원인**: 프린터의 한글 폰트 미지원 또는 인코딩 문제
- **해결**: 프린터 설정 확인 및 펌웨어 업데이트

## 기술적 특징

### 장점
1. **완전한 한글 지원**: EUC-KR 인코딩과 ESC/POS 명령어 조합
2. **정확한 텍스트 정렬**: 한글과 영문의 폭 차이를 고려한 계산
3. **안정적인 출력**: 임시 파일 사용으로 데이터 손실 방지
4. **사용자 친화적**: 상세한 에러 메시지와 해결 가이드
5. **유연한 설정**: 다양한 프린터와 출력 옵션 지원

### 의존성
- **Python 3**: 기본 런타임
- **CUPS**: Unix/Linux/macOS 프린터 서비스
- **subprocess**: 시스템 명령어 실행
- **tempfile**: 임시 파일 관리
- **argparse**: 명령행 인수 처리

### 호환성
- **운영체제**: macOS, Linux (CUPS 지원 시스템)
- **프린터**: BIXOLON SRP-330II (다른 ESC/POS 프린터도 호환 가능)
- **Python 버전**: Python 3.x

## 확장 가능성

### 추가 가능한 기능
1. **다양한 출력 포맷**: 영수증 템플릿, 바코드, QR 코드
2. **네트워크 프린터 지원**: TCP/IP 프린터 직접 연결
3. **GUI 인터페이스**: 데스크톱 애플리케이션 버전
4. **데이터베이스 연동**: 주문 정보 자동 출력
5. **웹 서비스**: REST API를 통한 원격 출력

### 코드 개선 방향
1. **설정 파일**: 프린터 설정의 외부 파일화
2. **로깅 시스템**: 출력 이력 및 오류 로그 관리
3. **테스트 코드**: 단위 테스트 및 통합 테스트 추가
4. **패키지화**: pip 설치 가능한 패키지로 변환

## 개발 환경 설정

### 필수 요구사항
1. Python 3.x 설치
2. CUPS 서비스 설치 및 실행
3. BIXOLON 프린터 드라이버 설치
4. 프린터를 CUPS에 등록

### 개발 시작하기
```bash
# 저장소 클론
git clone <repository-url>
cd receipt-printer

# 의존성 설치 (requirements.txt가 업데이트되면)
pip3 install -r requirements.txt

# 테스트 실행
python3 main.py "테스트 출력" --preview
```

이 프로젝트는 영수증 프린터의 기본적인 텍스트 출력 기능을 제공하며, 한글 지원과 사용자 편의성에 중점을 둔 실용적인 도구입니다.